yaml
    name: CI - ETL Project Tests

    on:
      push:
        branches: [ "main" ]
      pull_request:
        branches: [ "main" ]

    jobs:
      build:
        runs-on: ubuntu-latest

        services:
          postgres:
            image: postgres:14
            env:
              POSTGRES_DB: postgres
              POSTGRES_USER: postgres
              POSTGRES_PASSWORD: postgres
            ports:
              - 5432:5432
            options: >-
              --health-cmd pg_isready -U postgres -d postgres
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5

        steps:
          - uses: actions/checkout@v3

          - name: Set up Python 3.10
            uses: actions/setup-python@v3
            with:
              python-version: "3.10"

          - name: Install Python dependencies
            run: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt

          - name: Run database initialization script
            run: |
              PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -f table.sql
            env:
              POSTGRES_DB: postgres
              POSTGRES_USER: postgres
              POSTGRES_PASSWORD: postgres

          - name: Wait for PostgreSQL to be ready
            run: |
              sleep 30
              echo "Waiting for PostgreSQL to be ready..."
              PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -c "SELECT 1"
            env:
              POSTGRES_DB: postgres
              POSTGRES_USER: postgres
              POSTGRES_PASSWORD: postgres

          - name: Run extract script
            run: |
              python extract.py
            env:
              API_URL: https://jsonplaceholder.typicode.com/posts
              DB_HOST: localhost
              DB_NAME: postgres
              DB_USER: postgres
              DB_PASSWORD: postgres

          - name: Run transform script
            run: |
              python transform.py
            env:
              API_URL: https://jsonplaceholder.typicode.com/posts
              DB_HOST: localhost
              DB_NAME: postgres
              DB_USER: postgres
              DB_PASSWORD: postgres

          - name: Check raw_users_by_posts data
            run: |
              PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -c "SELECT COUNT(*) FROM raw_users_by_posts WHERE post_id IS NOT NULL" | grep -q "100"
            env:
              POSTGRES_DB: postgres
              POSTGRES_USER: postgres
              POSTGRES_PASSWORD: postgres

          - name: Check top_users_by_posts data
            run: |
              PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -c "SELECT COUNT(*) FROM top_users_by_posts WHERE user_id IS NOT NULL" | grep -q "10"
            env:
              POSTGRES_DB: postgres
              POSTGRES_USER: postgres
              POSTGRES_PASSWORD: postgres
  
